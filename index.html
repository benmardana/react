<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <link rel="stylesheet" href="styles.css">
  <title>React</title>
</head>

<body>
  <div id="root"></div>
</body>

<script>
  const React = (function () {
    let hooks = [];
    let currentHook = 0;
    return {
      useState(initialValue) {
        hooks[currentHook] = hooks[currentHook] === undefined ? initialValue : hooks[currentHook];
        const setStateHookIndex = currentHook;
        function setState(newState) {
          hooks[setStateHookIndex] = newState;
          renderApp(); // let react manage rerenders - in reality react is more magic than this
        }
        return [hooks[currentHook++], setState];
      },
      render(component, node) {
        currentHook = 0;
        node.innerHTML = '';
        node.appendChild(component);
      },
      createElement(tagName, props = {}, ...children) {
        const newElement = document.createElement(tagName);

        for (propKey of Object.keys(props)) {
          newElement[propKey] = props[propKey];
        }

        for (child of children) {
          newElement.appendChild(child);
        }

        return newElement;
      }
    }
  })();

  const createElement = React.createElement;
  function renderApp() {
    React.render(App(), document.getElementById('root'));
  }

  function App() {
    return createElement('div', {},
      Board()
    )
  }

  function calculateWinner(squares) {
    if (!squares) { return null }
    const lines = [
      [0, 1, 2],
      [3, 4, 5],
      [6, 7, 8],
      [0, 3, 6],
      [1, 4, 7],
      [2, 5, 8],
      [0, 4, 8],
      [2, 4, 6],
    ];
    for (let i = 0; i < lines.length; i++) {
      const [a, b, c] = lines[i];
      if (squares[a] && squares[a] === squares[b] && squares[a] === squares[c]) {
        return squares[a];
      }
    }
    return null;
  }

  function Square(index, innerText, onClick) {
    return createElement('button', { innerText, onclick: () => onClick(index) })
  }

  function Board() {
    const [squares, setSquares] = React.useState(null);
    const [xIsNext, setXIsNext] = React.useState(true);

    async function loadSaveState() {
      await new Promise(r => setTimeout(r, 2000));
      setSquares((await (await fetch('save-state.json')).json()).squares);
    }

    function onClick(index) {
      if (calculateWinner(squares) || squares[index]) {
        return;
      }
      const squaresCopy = squares.slice();
      squaresCopy[index] = xIsNext ? 'X' : 'O';
      setXIsNext(!xIsNext); // causes a whole reload
      setSquares(squaresCopy);
    }

    const winner = calculateWinner(squares);
    let status;
    if (winner) {
      status = 'Winner: ' + winner;
    } else {
      status = 'Next player: ' + (xIsNext ? 'X' : 'O');
    }

    document.title = winner ? 'Game Over!' : 'Tic-Tac-Toe'

    if (!squares) {
      loadSaveState();
      return createElement('div', { className: "game", innerText: "loading..." });
    }

    return createElement('div', { className: "game" },
      createElement('div', { className: "game-board" },
        createElement('div', { className: "board-row" },
          Square(0, squares[0], onClick),
          Square(1, squares[1], onClick),
          Square(2, squares[2], onClick)
        ),
        createElement('div', { className: "board-row" },
          Square(3, squares[3], onClick),
          Square(4, squares[4], onClick),
          Square(5, squares[5], onClick)
        ),
        createElement('div', { className: "board-row" },
          Square(6, squares[6], onClick),
          Square(7, squares[7], onClick),
          Square(8, squares[8], onClick)
        ),
      ),
      createElement('div', { className: "game-info" },
        createElement('div', { innerText: status })
      )
    )
  }

  window.onload = renderApp();
</script>

</html>
